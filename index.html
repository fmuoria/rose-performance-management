<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quarterly Performance Scorecard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1100px;
      background: #fff;
      margin: 30px auto 30px auto;
      border-radius: 18px;
      box-shadow: 0 10px 32px rgba(80,60,120,0.15);
      padding: 36px 28px 30px 28px;
    }
    h1, h2 {
      text-align: center;
      color: #2c3e50;
      margin-top: 0;
    }
    .info-row {
      display: flex;
      gap: 30px;
      margin-bottom: 22px;
      flex-wrap: wrap;
    }
    .info-col {
      flex: 1;
      min-width: 220px;
    }
    label {
      font-weight: bold;
      color: #444;
    }
    .scorecard-table {
      width: 100%;
      border-collapse: collapse;
      margin: 30px 0;
      background: #fafafa;
    }
    .scorecard-table th, .scorecard-table td {
      border: 1px solid #d1d5db;
      padding: 10px 8px;
      font-size: 1rem;
      vertical-align: top;
    }
    .scorecard-table th {
      background: #f2f6fa;
      color: #34495e;
      font-weight: bold;
    }
    .scorecard-section-header {
      background: #667eea;
      color: #fff;
      font-size: 1.1rem;
      letter-spacing: 0.05em;
    }
    .section-total-row {
      background: #e4e8f8;
      font-weight: bold;
    }
    .final-total-row {
      background: #27ae60;
      color: #fff;
      font-weight: bold;
      font-size: 1.12rem;
    }
    input[type="number"], select, textarea {
      font-size: 1rem;
      padding: 6px;
      width: 100%;
      border: 1.5px solid #e1e6ef;
      border-radius: 5px;
      background: #f8fafc;
      box-sizing: border-box;
      margin-top: 2px;
    }
    textarea {
      resize: vertical;
      min-height: 32px;
      max-height: 90px;
    }
    input[type="number"]:disabled, textarea:disabled {
      background: #f1f1f6;
      color: #999;
    }
    .legend, .score-summary {
      margin: 25px 0 5px 0;
      padding: 15px 18px;
      background: #fdf6e3;
      border-radius: 10px;
      color: #856404;
      font-size: 1rem;
    }
    .score-summary {
      background: #eafaf1;
      color: #1e824c;
      font-size: 1.08rem;
    }
    .btn-row {
      text-align: center;
      margin: 32px 0 14px 0;
    }
    button {
      background: linear-gradient(90deg, #667eea 70%, #764ba2 100%);
      color: #fff;
      font-weight: bold;
      font-size: 1rem;
      border: none;
      border-radius: 7px;
      padding: 12px 34px;
      margin: 7px 10px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(80,60,120,0.10);
      transition: transform 0.08s;
    }
    button:active {
      transform: scale(0.97);
    }
    .manager-comment {
      background: #f5faff;
      border-left: 4px solid #3498db;
      padding: 4px 8px;
      color: #2d3748;
    }
    .progress-box {
      margin: 20px 0 35px 0;
      padding: 17px 18px;
      background: #f4f7fb;
      border-radius: 12px;
      color: #3a4765;
      font-size: 1.03rem;
    }
    .progress-bar-wrap {
      background: #e8ecfd;
      border-radius: 7px;
      overflow: hidden;
      margin-top: 10px;
      height: 20px;
      width: 100%;
    }
    .progress-bar {
      background: linear-gradient(90deg,#27ae60 70%, #2ecc71 100%);
      height: 100%;
      transition: width 0.6s;
      color: #fff;
      line-height: 20px;
      font-weight: 600;
      text-align: center;
      font-size: 1rem;
    }
    @media (max-width: 900px) {
      .container { padding: 16px 2vw; }
      .info-row { flex-direction: column; gap: 10px;}
    }
    @media (max-width: 600px) {
      .container { padding: 7px 0; }
      .scorecard-table th, .scorecard-table td { font-size: 0.93rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Quarterly Performance Scorecard</h1>
    <form id="scorecardForm" autocomplete="off">
      <div class="info-row">
        <div class="info-col">
          <label for="employeeName">Employee's Name:</label><br>
          <select id="employeeName" required>
            <option value="">Loading...</option>
          </select>
        </div>
        <div class="info-col">
          <label for="employeeJob">Job Title:</label><br>
          <select id="employeeJob" required>
            <option value="">Select Employee First</option>
          </select>
        </div>
        <div class="info-col">
          <label for="division">Division:</label><br>
          <select id="division" required>
            <option value="">Select Employee First</option>
          </select>
        </div>
        <div class="info-col">
          <label for="periodYear">Year:</label><br>
          <select id="periodYear">
            <option value="2025">2025</option>
          </select>
        </div>
        <div class="info-col">
          <label for="periodMonth">Month:</label><br>
          <select id="periodMonth" required>
            <option value="">Select</option>
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        <div class="info-col">
          <label for="periodWeek">Week:</label><br>
          <select id="periodWeek" required>
            <option value="">Select</option>
            <option value="1">Week 1</option>
            <option value="2">Week 2</option>
            <option value="3">Week 3</option>
            <option value="4">Week 4</option>
            <option value="5">Week 5</option>
          </select>
        </div>
      </div>

      <div class="progress-box" id="progressBox" style="display:none;">
        <div id="progressText"></div>
        <div class="progress-bar-wrap" style="margin-bottom:8px;">
          <div class="progress-bar" id="progressBar" style="width:0%"></div>
        </div>
      </div>

      <table class="scorecard-table" id="scorecardTable">
        <thead>
          <tr>
            <th style="width: 20%;">Dimension</th>
            <th style="width: 24%;">Performance Measure</th>
            <th style="width: 15%;">Target</th>
            <th style="width: 18%;">Actual<br><span style="font-weight:normal;">(employee input)</span></th>
            <th style="width: 8%;">Rating<br>(1-5)</th>
            <th style="width: 7%;">Weight<br>(%)</th>
            <th style="width: 10%;">Weighted<br>Average</th>
            <th style="width: 20%;">Manager's Comments</th>
          </tr>
        </thead>
        <tbody id="scorecardBody">
          <!-- Scorecard rows rendered by JS -->
        </tbody>
      </table>

      <div class="btn-row">
        <button type="button" onclick="saveScorecard()">Save</button>
        <button type="reset">Reset</button>
      </div>
    </form>
    <div class="score-summary" id="scoreSummary"></div>
    <div class="legend">
      <b>Score Legend:</b><br>
      1.00–1.99 Not met;&nbsp; 2.00–2.99 Partially met;&nbsp; 3.00–3.99 Met;&nbsp; 4.00–4.99 Generally Exceeding;&nbsp; 5.00 Exceeded by far
    </div>
  </div>
  <script>
    // --- CONFIGURATION ---
    const EMPLOYEE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1iPMxDd4oyG0Jcl25ryb-1CY-x4qwnlaFLwpUOGJ7qEAg3sEEHSTYPzpGA7ZMJ31LDDqppfuxslNB/pub?gid=0&single=true&output=csv";

    // --- SCORECARD TEMPLATE (static for now, could be made dynamic) ---
    const SCORECARD_SECTIONS = [
      {
        title: "Financials",
        weight: 10,
        rows: [
          {
            dimension: "The individual should employ measures that help in reducing operational costs",
            measure: "Employing Cost cutting measures to ensure no organisation over spending, specifically on transport, airtime",
            target: "Spend 2% less on org IT Budget",
            weight: 10
          }
        ]
      },
      {
        title: "Customer Perspective",
        weight: 20,
        rows: [
          {
            dimension: "The individual should display exemplary service to the customers (Internal or external) whom they work with/assist in day to day operations",
            measure: "Turnaround time of Service to internal Customers",
            target: "Avg. response time: 24h (general), 1h (urgent), 6h (consultations)",
            weight: 10
          },
          {
            dimension: "",
            measure: "Relationship with Internal ROSE stakeholders",
            target: "Minimal to no relationship complaints",
            weight: 10
          }
        ]
      },
      {
        title: "Internal Business Processes",
        weight: 45,
        rows: [
          {
            dimension: "Salesforce and Taroworks Management/Support",
            measure: "Percentage of reported issues resolved",
            target: "100% issues resolved",
            weight: 10
          },
          {
            dimension: "Digital Capacity Building Sessions (Trainers, Staff, Data Team)",
            measure: "Number of group sessions conducted monthly & percentage upskill in ROSE members",
            target: "3 sessions/month, 70% upskill",
            weight: 15
          },
          {
            dimension: "IT Maintenance and Troubleshooting",
            measure: "Frequency of scheduled maintenance & % device issues resolved",
            target: "Quarterly, 90% device issues resolved",
            weight: 15
          },
          {
            dimension: "Data Analysis",
            measure: "Number of audited monthly reports generated",
            target: "2 reports biannually",
            weight: 5
          }
        ]
      },
      {
        title: "Learning and Growth",
        weight: 15,
        rows: [
          {
            dimension: "",
            measure: "Hours of Career Development",
            target: "40 hours learning in 6 months",
            weight: 5
          },
          {
            dimension: "",
            measure: "Business Continuity Planning",
            target: "At least 1 trained individual who can relieve duties",
            weight: 5
          },
          {
            dimension: "",
            measure: "Innovations and Recommendations",
            target: "1 innovation/quarter, 3 improvement recommendations",
            weight: 5
          }
        ]
      },
      {
        title: "Work Ethic",
        weight: 10,
        rows: [
          {
            dimension: "Time management (Punctuality)",
            measure: "Reports for office meetings and functions on time",
            target: "",
            weight: 0.8
          },
          {
            dimension: "",
            measure: "Meets deadlines",
            target: "",
            weight: 0.8
          },
          {
            dimension: "",
            measure: "Shows up and works agreed-upon hours",
            target: "",
            weight: 0.8
          },
          {
            dimension: "Integrity",
            measure: "Fosters trusting relationships with clients, coworkers and supervisors",
            target: "",
            weight: 0.8
          },
          {
            dimension: "",
            measure: "Supervisors rely on the employee's high moral standards",
            target: "",
            weight: 0.8
          },
          {
            dimension: "Productivity",
            measure: "Does more than the bare minimum to deliver results to customers",
            target: "",
            weight: 0.8
          },
          {
            dimension: "",
            measure: "Cares about the quality of the work, not just the quantity of the work",
            target: "",
            weight: 0.8
          },
          {
            dimension: "Professionalism",
            measure: "Complies with standard office attire",
            target: "",
            weight: 0.8
          },
          {
            dimension: "",
            measure: "Maintains a professional outlook",
            target: "",
            weight: 0.8
          },
          {
            dimension: "",
            measure: "Adheres to Standard Operating Procedures",
            target: "",
            weight: 0.8
          },
          {
            dimension: "",
            measure: "Takes responsibility and ownership of assigned role",
            target: "",
            weight: 0.8
          },
          {
            dimension: "Teamwork",
            measure: "Takes responsibility for other people’s welfare",
            target: "",
            weight: 0.8
          },
          {
            dimension: "",
            measure: "Fair and objective treatment of other staff members",
            target: "",
            weight: 0.8
          }
        ]
      }
    ];

    // --- EMPLOYEE DATA ---
    let employeeData = [];
    let uniqueJobTitles = [];
    let uniqueDivisions = [];

    // --- PROGRESS TRACKING ---
    function getProgressKey() {
      // progress tracked by empName|year|month
      const emp = document.getElementById("employeeName").value || "";
      const y = document.getElementById("periodYear").value || "";
      const m = document.getElementById("periodMonth").value || "";
      return emp + "|" + y + "|" + m;
    }
    function getProgress() {
      const key = getProgressKey();
      return JSON.parse(localStorage.getItem("scorecardProgress") || "{}")[key] || [];
    }
    function setProgress(week) {
      const key = getProgressKey();
      let progress = JSON.parse(localStorage.getItem("scorecardProgress") || "{}");
      if (!progress[key]) progress[key] = [];
      if (!progress[key].includes(week)) progress[key].push(week);
      localStorage.setItem("scorecardProgress", JSON.stringify(progress));
    }
    function updateProgressBar() {
      const month = document.getElementById("periodMonth").value;
      if (!month) { document.getElementById("progressBox").style.display = "none"; return; }

      const weeks = [1,2,3,4,5];
      const saved = getProgress();
      const completed = saved.length;
      document.getElementById("progressBox").style.display = "";
      document.getElementById("progressText").textContent =
        `Progress for this month: ${completed} of ${weeks.length} weeks completed. Weeks filled: ${saved.join(", ") || "None"}`;
      document.getElementById("progressBar").style.width = (completed / weeks.length * 100) + "%";
      document.getElementById("progressBar").textContent = completed === weeks.length ? "Complete" : `${completed}/${weeks.length}`;
    }

    // --- CSV PARSER (for Google Sheets) ---
    function parseCSV(text) {
      // Handles quoted fields, commas, etc.
      const rows = [];
      let row = [], insideQuote = false, field = '';
      for (let i = 0, c; i <= text.length; ++i) {
        c = text[i] || '\n';
        if (insideQuote) {
          if (c === '"') {
            if (text[i+1] === '"') { field += '"'; ++i; }
            else insideQuote = false;
          } else field += c;
        } else {
          if (c === '"') insideQuote = true;
          else if (c === ',' || c === '\n') {
            row.push(field.trim());
            field = '';
            if (c === '\n') { rows.push(row); row = []; }
          } else field += c;
        }
      }
      return rows.filter(r=>r.length>1);
    }

    // --- POPULATE EMPLOYEE DROPDOWN ---
    function populateEmployeeDropdown() {
      const select = document.getElementById("employeeName");
      select.innerHTML = '<option value="">Select</option>' +
        employeeData.map(emp => `<option value="${emp.Name}">${emp.Name}</option>`).join('');
    }

    // --- POPULATE JOB TITLE/DIVISION BASED ON EMPLOYEE ---
    function handleEmployeeChange() {
      const name = document.getElementById("employeeName").value;
      const emp = employeeData.find(e => e.Name === name);
      // Populate job titles
      const jt = document.getElementById("employeeJob");
      if (emp) {
        jt.innerHTML = `<option value="${emp.Title}">${emp.Title}</option>`;
        jt.value = emp.Title;
        jt.disabled = false;
        const div = document.getElementById("division");
        div.innerHTML = `<option value="${emp.DPT}">${emp.DPT}</option>`;
        div.value = emp.DPT;
        div.disabled = false;
      } else {
        jt.innerHTML = '<option value="">Select Employee First</option>';
        jt.disabled = true;
        document.getElementById("division").innerHTML = '<option value="">Select Employee First</option>';
        document.getElementById("division").disabled = true;
      }
    }

    // --- SCORECARD RENDERING ---
    function renderScorecardRows() {
      const tbody = document.getElementById("scorecardBody");
      let idx = 0;
      let html = "";
      SCORECARD_SECTIONS.forEach(section => {
        html += `<tr class="scorecard-section-header"><td colspan="8">${section.title}</td></tr>`;
        section.rows.forEach(row => {
          html += `<tr data-section="${section.title}" data-row="${idx}">
            <td>${row.dimension || ""}</td>
            <td>${row.measure}</td>
            <td>${row.target}</td>
            <td><textarea name="actual" spellcheck="true"></textarea></td>
            <td><input type="number" min="1" max="5" step="0.1" name="rating" required></td>
            <td><input type="number" name="weight" value="${row.weight}" disabled></td>
            <td><input type="number" name="weighted" step="0.001" disabled></td>
            <td><textarea name="managerComment" disabled></textarea></td>
          </tr>`;
          idx++;
        });
        html += `<tr class="section-total-row"><td colspan="5">${section.title} Subtotal</td><td>${section.weight}%</td><td class="sectionSubtotal" data-section="${section.title}"></td><td></td></tr>`;
      });
      html += `<tr class="final-total-row"><td colspan="6">TOTAL SCORE</td><td id="finalTotal"></td><td></td></tr>`;
      tbody.innerHTML = html;
      attachScorecardListeners();
      updateCalculations();
    }

    function calcWeighted(rating, weight) {
      if (isNaN(rating) || isNaN(weight)) return '';
      return +(rating * (weight / 100)).toFixed(3);
    }

    // --- CALCULATE & UPDATE WEIGHTED & TOTALS ---
    function updateCalculations() {
      const tbody = document.getElementById("scorecardBody");
      const rows = Array.from(tbody.querySelectorAll('tr')).filter(tr => tr.querySelector('input[name="rating"]'));
      let sectionSum = {}, sectionCount = {}, finalTotal = 0;
      // Calculate weighted averages per row
      rows.forEach(tr => {
        const rating = parseFloat(tr.querySelector('input[name="rating"]').value) || 0;
        const weight = parseFloat(tr.querySelector('input[name="weight"]').value) || 0;
        const weighted = calcWeighted(rating, weight);
        tr.querySelector('input[name="weighted"]').value = weighted || '';
        const section = tr.getAttribute("data-section");
        if (!sectionSum[section]) sectionSum[section] = 0;
        sectionSum[section] += weighted || 0;
      });
      // Set subtotals per section
      tbody.querySelectorAll('.sectionSubtotal').forEach(td => {
        const section = td.getAttribute("data-section");
        td.textContent = sectionSum[section] ? sectionSum[section].toFixed(3) : '';
        finalTotal += sectionSum[section] || 0;
      });
      // Set final total
      document.getElementById('finalTotal').textContent = finalTotal ? finalTotal.toFixed(3) : '';
      // Score summary
      let category = '';
      if (finalTotal >= 5) category = "Exceeded by far";
      else if (finalTotal >= 4) category = "Generally Exceeding";
      else if (finalTotal >= 3) category = "Met";
      else if (finalTotal >= 2) category = "Partially met";
      else if (finalTotal > 0) category = "Not met";
      document.getElementById('scoreSummary').textContent = finalTotal ? `Your overall score for this week: ${finalTotal.toFixed(2)}. Category: ${category}.` : '';
    }

    function attachScorecardListeners() {
      const tbody = document.getElementById("scorecardBody");
      tbody.querySelectorAll('input[name="rating"]').forEach(input => {
        input.addEventListener('input', updateCalculations);
      });
    }

    // --- SAVE SCORECARD (and progress) ---
    function saveScorecard() {
      const emp = document.getElementById("employeeName").value;
      const job = document.getElementById("employeeJob").value;
      const div = document.getElementById("division").value;
      const year = document.getElementById("periodYear").value;
      const month = document.getElementById("periodMonth").value;
      const week = document.getElementById("periodWeek").value;
      if (!(emp && job && div && year && month && week)) {
        alert("Please complete all header fields.");
        return;
      }
      const tbody = document.getElementById("scorecardBody");
      const rows = Array.from(tbody.querySelectorAll('tr')).filter(tr => tr.querySelector('input[name="rating"]'));
      const dataRows = rows.map(tr => ({
        dimension: tr.children[0].textContent,
        measure: tr.children[1].textContent,
        target: tr.children[2].textContent,
        actual: tr.querySelector('textarea[name="actual"]').value,
        rating: tr.querySelector('input[name="rating"]').value,
        weight: tr.querySelector('input[name="weight"]').value,
        weighted: tr.querySelector('input[name="weighted"]').value,
        managerComment: tr.querySelector('textarea[name="managerComment"]').value
      }));
      const scoreData = {
        employee: emp,
        job,
        division: div,
        year,
        month,
        week,
        rows: dataRows,
        total: document.getElementById("finalTotal").textContent,
        summary: document.getElementById("scoreSummary").textContent
      };
      // Save to localStorage (simulate backend)
      let allScores = JSON.parse(localStorage.getItem("weeklyScores") || "[]");
      // Remove existing for this emp/week/month
      allScores = allScores.filter(s => !(s.employee===emp && s.year===year && s.month===month && s.week===week));
      allScores.push(scoreData);
      localStorage.setItem("weeklyScores", JSON.stringify(allScores));
      setProgress(week);
      updateProgressBar();
      alert("Scorecard saved for this week (locally).");
    }

    // --- INITIALIZATION ---
    async function initializeEmployeeDropdowns() {
      try {
        const resp = await fetch(EMPLOYEE_CSV_URL);
        const text = await resp.text();
        const arr = parseCSV(text);
        // Find header row
        let headerIdx = 0;
        while (headerIdx < arr.length && !arr[headerIdx].some(h => h.trim().toLowerCase() === "name")) ++headerIdx;
        if (headerIdx >= arr.length) throw "No header row with 'Name' found";
        const headers = arr[headerIdx];
        const nameCol = headers.findIndex(h => h.trim().toLowerCase() === "name");
        const titleCol = headers.findIndex(h => h.trim().toLowerCase() === "title");
        const dptCol = headers.findIndex(h => h.trim().toLowerCase() === "dpt");
        employeeData = arr.slice(headerIdx+1)
          .filter(row => row[nameCol])
          .map(row => ({
            Name: row[nameCol],
            Title: row[titleCol] || "",
            DPT: row[dptCol] || ""
          }));
        populateEmployeeDropdown();
      } catch (e) {
        document.getElementById("employeeName").innerHTML = `<option value="">Could not load</option>`;
      }
    }

    // --- EVENT HANDLERS ---
    document.getElementById("employeeName").addEventListener("change", handleEmployeeChange);
    document.getElementById("periodMonth").addEventListener("change", updateProgressBar);

    // For week, update progress bar on change
    document.getElementById("periodWeek").addEventListener("change", updateProgressBar);

    // --- ONLOAD ---
    window.onload = function() {
      initializeEmployeeDropdowns();
      renderScorecardRows();
      updateProgressBar();
      document.getElementById("scorecardForm").addEventListener("reset", function() {
        setTimeout(function() {
          renderScorecardRows();
          updateProgressBar();
        }, 50);
      });
    }
  </script>
</body>
</html>
